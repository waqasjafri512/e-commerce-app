<%- include('../includes/head.ejs') %>
<link rel="stylesheet" href="/css/product.css">
</head>
<body>
<%- include('../includes/navigation.ejs') %>
<main>
  <form method="GET" action="/products" style="margin: 1rem 0; display:grid; grid-template-columns: repeat(4,1fr); gap:8px;">
    <input type="text" id="search-input" name="search" placeholder="Search products" value="<%= filters?.search || '' %>">
    <select name="category"><option value="">All Categories</option><% facets.categories.forEach(c=> { %><option value="<%= c %>" <%= filters?.category===c ? 'selected': '' %>><%= c %></option><% }) %></select>
    <select name="brand"><option value="">All Brands</option><% facets.brands.forEach(c=> { %><option value="<%= c %>" <%= filters?.brand===c ? 'selected': '' %>><%= c %></option><% }) %></select>
    <select name="sort"><option value="newest">Newest</option><option value="price_asc">Price Low-High</option><option value="price_desc">Price High-Low</option><option value="rating_desc">Top Rated</option></select>
    <input type="number" step="0.01" name="minPrice" placeholder="Min price" value="<%= filters?.minPrice || '' %>">
    <input type="number" step="0.01" name="maxPrice" placeholder="Max price" value="<%= filters?.maxPrice || '' %>">
    <select name="size"><option value="">All Sizes</option><% facets.sizes.forEach(c=> { %><option value="<%= c %>" <%= filters?.size===c ? 'selected': '' %>><%= c %></option><% }) %></select>
    <select name="color"><option value="">All Colors</option><% facets.colors.forEach(c=> { %><option value="<%= c %>" <%= filters?.color===c ? 'selected': '' %>><%= c %></option><% }) %></select>
    <button class="btn" type="submit">Apply Filters</button>
  </form>

  <div id="suggestions" style="background:white; max-width:400px;"></div>

  <% if (prods.length > 0) { %>
    <div class="grid">
      <% for (let product of prods) { %>
        <article class="card product-item">
          <header class="card__header"><h1 class="product__title"><%= product.title %></h1></header>
          <div class="card__image"><img src="/<%= product.imageUrl %>" alt="<%= product.title %>"></div>
          <div class="card__content">
            <h2 class="product__price">$<%= product.price %></h2>
            <p><strong><%= product.brand %></strong> • <%= product.category %> • <%= product.color %> / <%= product.size %></p>
            <p>⭐ <%= product.averageRating || 0 %> (<%= product.reviewCount || 0 %> reviews)</p>
            <p class="product__description"><%= product.description %></p>
          </div>
          <div class="card__actions">
            <a href="/products/<%= product._id %>" class="btn">Details</a>
            <% if (isAuthenticated) { %>
              <%- include('../includes/add-to-cart.ejs', {product: product}) %>
              <form action="/wishlist/toggle" method="POST">
                <input type="hidden" name="productId" value="<%= product._id %>">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button class="btn" type="submit"><%= product.isWishlisted ? '♥ Saved' : '♡ Wishlist' %></button>
              </form>
            <% } %>
          </div>
        </article>
      <% } %>
    </div>
    <%- include('../includes/pagination.ejs', {currentPage: currentPage, nextPage: nextPage, previousPage: previousPage, lastPage: lastPage, hasNextPage: hasNextPage, hasPreviousPage: hasPreviousPage}) %>
  <% } else { %>
    <h1>No Products Found!</h1>
  <% } %>
</main>
<script src="/js/search-autocomplete.js"></script>
<%- include('../includes/end.ejs') %>
